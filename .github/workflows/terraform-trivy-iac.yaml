name: Deploy Infrastructure

on:
  # Run when someone opens a PR that changes infrastructure code
  pull_request:
    paths: ['terraform-code/**']
  
  # Run when code is pushed to dev or main branches
  push:
    branches: [ dev, main ]
    paths: ['terraform-code/**']
  
  # Allow manual deployment with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: "Which environment do you want to deploy?"
        required: true
        type: choice
        options: [staging, production]

permissions:
  id-token: write    # Needed for Azure authentication
  contents: read     # Needed to read the repository

# Prevent multiple deployments running at the same time
concurrency:
  group: terraform-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    
    # Choose environment based on how the workflow was triggered
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || (github.ref_name == 'main' && 'production' || 'staging') }}

    # Azure credentials for authentication
    env:
      ARM_CLIENT_ID:       ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID:       ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_USE_OIDC:        true

    steps:
      # Get the latest code
      - name: Get code from repository
        uses: actions/checkout@v4

      # Figure out which environment we're deploying to
      - name: Determine target environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual deployment - use selected environment
            echo "target=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            # Push to main branch - deploy to production
            echo "target=production" >> $GITHUB_OUTPUT
          else
            # Push to other branches - deploy to staging
            echo "target=staging" >> $GITHUB_OUTPUT
          fi
          echo "Deploying to: ${{ steps.env.outputs.target }}"

      # Set up paths for this specific environment
      - name: Set up environment paths
        run: |
          echo "TF_DIR=terraform-code/environments/${{ steps.env.outputs.target }}" >> $GITHUB_ENV
          echo "TFVARS=${{ steps.env.outputs.target }}.tfvars" >> $GITHUB_ENV
          echo "Working with directory: terraform-code/environments/${{ steps.env.outputs.target }}"
          echo "Using variables file: ${{ steps.env.outputs.target }}.tfvars"

      # Install Terraform
      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # Login to Azure using OIDC (no passwords needed!)
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Read which version of modules to use
      - name: Read module version
        run: |
          MODULE_VERSION=$(cat $TF_DIR/module-ref.txt | tr -d '[:space:]')
          echo "MODULE_REF=$MODULE_VERSION" >> $GITHUB_ENV
          echo "Using module version: $MODULE_VERSION"

      # Process templates if they exist (convert .tmpl files to actual files)
      - name: Process Terraform templates
        run: |
          echo "Processing any Terraform templates..."
          
          # Check if we have any .tmpl files in the stack directory
          if [ -d "terraform-code/stack" ] && [ -n "$(find terraform-code/stack -name '*.tmpl' -type f)" ]; then
            echo "Found template files in terraform-code/stack/"
            
            # Process each .tmpl file
            for template in terraform-code/stack/*.tmpl; do
              if [ -f "$template" ]; then
                output_file="${template%.tmpl}"
                echo "Processing: $template -> $output_file"
                
                # Use envsubst to substitute environment variables
                # You can also use other template processors here if needed
                envsubst < "$template" > "$output_file"
                
                echo "âœ… Created: $output_file"
              fi
            done
          else
            echo "â„¹ï¸  No template files found in terraform-code/stack/ - skipping template processing"
          fi

      # Verify main.tf calls the stack module correctly
      - name: Verify main.tf configuration
        run: |
          echo "Verifying main.tf calls the stack module..."
          if grep -q "module.*stack" "$TF_DIR/main.tf"; then
            echo "âœ… main.tf calls stack module"
            echo "Content preview:"
            cat "$TF_DIR/main.tf"
          else
            echo "âŒ ERROR: main.tf doesn't call stack module"
            exit 1
          fi

      # Double-check that all required modules exist in the infrastructure repo
      - name: Verify infrastructure modules exist
        run: |
          echo "Checking if all required modules exist at version ${MODULE_REF}..."
          
          # Clone the infrastructure repo temporarily
          git init /tmp/infra
          cd /tmp/infra
          git remote add origin https://github.com/rare-beauty/terraform-infrastructure.git
          
          # Try to get the specific version
          if git fetch --depth 1 origin "${MODULE_REF}"; then
            git checkout FETCH_HEAD
          else
            git fetch --depth 1 origin && git checkout "${MODULE_REF}" || {
              echo "âŒ ERROR: Cannot find version ${MODULE_REF} in infrastructure repo"
              exit 1
            }
          fi
          
          # Check all required modules exist
          REQUIRED_MODULES="resourcegroup virtualnetwork subnet acr azurekeyvault aks rbac"
          for module in $REQUIRED_MODULES; do
            if [ ! -d "terraform/modules/$module" ]; then
              echo "âŒ ERROR: Missing required module: $module"
              exit 1
            fi
          done
          
          echo "âœ… All required modules found at version ${MODULE_REF}"

      # Verify required configuration files exist
      - name: Verify configuration files exist
        run: |
          echo "Checking for required configuration files in $TF_DIR..."
          
          # Check for provider.tf (contains backend config)
          if [ -f "$TF_DIR/provider.tf" ]; then
            echo "âœ… Provider configuration found (provider.tf)"
            # Verify it contains backend configuration
            if grep -q "backend.*azurerm" "$TF_DIR/provider.tf"; then
              echo "âœ… Backend configuration found in provider.tf"
            else
              echo "âš ï¸  WARNING: No backend configuration found in provider.tf"
            fi
          else
            echo "âŒ ERROR: provider.tf not found in $TF_DIR"
            exit 1
          fi
          
          # Check for variables file
          if [ -f "$TF_DIR/variable.tf" ]; then
            echo "âœ… Variables file found (variable.tf)"
          else
            echo "âŒ ERROR: variable.tf not found in $TF_DIR"
            exit 1
          fi
          
          # Check for tfvars file
          if [ -f "$TF_DIR/${{ steps.env.outputs.target }}.tfvars" ]; then
            echo "âœ… Environment variables file found (${{ steps.env.outputs.target }}.tfvars)"
          else
            echo "âŒ ERROR: ${{ steps.env.outputs.target }}.tfvars not found in $TF_DIR"
            exit 1
          fi
          
          # Check for main.tf file (should exist since it calls the stack module)
          if [ -f "$TF_DIR/main.tf" ]; then
            echo "âœ… Main configuration found (main.tf)"
          else
            echo "âŒ ERROR: main.tf not found in $TF_DIR"
            echo "Expected to find main.tf that calls the stack module"
            exit 1
          fi
          
          # Check for datasources.tf (optional)
          if [ -f "$TF_DIR/datasources.tf" ]; then
            echo "âœ… Data sources configuration found (datasources.tf)"
          else
            echo "â„¹ï¸  datasources.tf not found - this is optional"
          fi
          
          # If stack directory exists, verify its files too
          if [ -d "terraform-code/stack" ]; then
            echo "Checking stack directory files..."
            
            # Check if main.tf exists in stack (after template processing)
            if [ -f "terraform-code/stack/main.tf" ]; then
              echo "âœ… Stack main.tf found"
              echo "First few lines of stack main.tf:"
              head -5 terraform-code/stack/main.tf
            else
              echo "âš ï¸  Stack main.tf not found - this may be expected if using templates"
            fi
            
            # List all files in stack directory for debugging
            echo "Stack directory contents:"
            ls -la terraform-code/stack/
          fi
          
          echo "âœ… All required configuration files verified!"

      # Clean up any old Terraform state to avoid conflicts
      - name: Clean up old Terraform cache
        run: |
          echo "Cleaning up old Terraform files..."
          rm -rf "$TF_DIR/.terraform"
          rm -f  "$TF_DIR/.terraform.lock.hcl"
          echo "âœ… Cleanup complete"

      # Format Terraform files to make them look nice
      - name: Format Terraform files
        run: |
          echo "Formatting Terraform files..."
          terraform -chdir=$TF_DIR fmt -recursive
          echo "âœ… Files formatted"

      # Check that formatting is correct
      - name: Verify Terraform formatting
        run: |
          echo "Checking Terraform formatting..."
          terraform -chdir=$TF_DIR fmt -check -recursive
          echo "âœ… Formatting is correct"

      # Initialize Terraform (download providers, set up backend)
      - name: Initialize Terraform
        run: |
          echo "Initializing Terraform..."
          # Backend config is in provider.tf, so no separate backend-config needed
          terraform -chdir=$TF_DIR init -upgrade
          echo "âœ… Terraform initialized"

      # Show what versions we're using
      - name: Show Terraform version info
        run: |
          echo "Terraform version:"
          terraform -chdir=$TF_DIR version
          echo ""
          echo "Providers being used:"
          terraform -chdir=$TF_DIR providers

      # Validate that our Terraform configuration is correct
      - name: Validate Terraform configuration
        run: |
          echo "Validating Terraform configuration..."
          echo "Validating environment directory: $TF_DIR"
          
          # Validate the environment-specific configuration
          terraform -chdir=$TF_DIR validate
          echo "âœ… Environment configuration is valid"
          
          # If stack directory exists and has main.tf, validate it too
          if [ -f "terraform-code/stack/main.tf" ]; then
            echo "Validating stack configuration..."
            echo "Initializing stack directory first..."
            
            # Initialize the stack directory to download modules
            terraform -chdir=terraform-code/stack init -upgrade
            
            # Now validate the stack configuration
            terraform -chdir=terraform-code/stack validate
            echo "âœ… Stack configuration is valid"
          else
            echo "â„¹ï¸  Stack main.tf not found - skipping stack validation"
          fi

      # Create a plan showing what changes will be made
      - name: Create deployment plan
        run: |
          echo "Creating deployment plan..."
          echo "Using module reference: $MODULE_REF"
          terraform -chdir=$TF_DIR plan -input=false -var-file=$TFVARS -var="module_ref=$MODULE_REF" -out=tfplan
          echo "âœ… Plan created successfully"

      # Convert plan to JSON for security scanning
      - name: Convert plan to JSON
        run: |
          echo "Converting plan to JSON for security analysis..."
          terraform -chdir=$TF_DIR show -json tfplan > tfplan.json
          echo "âœ… JSON plan created"

      # Run security checks on our Terraform code
      - name: Run security scan on code
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TF_DIR }}
          quiet: true

      # Run security checks on our deployment plan
      - name: Run security scan on plan
        uses: bridgecrewio/checkov-action@v12
        with:
          file: ${{ env.TF_DIR }}/tfplan.json
          quiet: true

      # For production deployments, require manual approval
      - name: Request approval for production deployment
        if: steps.env.outputs.target == 'production'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: vinaypalvirk51, sukhdeep26
          minimum-approvals: 1

      # Actually deploy the infrastructure
      - name: Deploy infrastructure
        if: steps.env.outputs.target != 'production' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸš€ Deploying infrastructure to ${{ steps.env.outputs.target }}..."
          echo "Using module reference: $MODULE_REF"
          terraform -chdir=$TF_DIR apply -input=false -auto-approve tfplan
          echo "âœ… Deployment completed successfully"